import * as vscode from 'vscode';
import { getRailsMapping } from '../rails/mapping';
import { getExpectedTestPath } from '../rails/expectedPaths';
import { fileExists, getWorkspaceFolder } from '../vscode/fileUtils';

export async function openTestForCurrentFile(): Promise<void> {
  const mapping = getRailsMapping();
  if (!mapping || mapping.fileType === 'test') {
    vscode.window.showWarningMessage('Select a Rails class (model, controller, â€¦) to view tests for.');
    return;
  }

  const { generatorType, className } = mapping;
  const workspaceFolder = getWorkspaceFolder();
  if (!workspaceFolder) return;
  
  const testFileUri = getExpectedTestPath(generatorType, className, workspaceFolder);
  if (!(await fileExists(testFileUri))) {
    vscode.window.showErrorMessage('No test file found.');
    return;
  }

  const doc = await vscode.workspace.openTextDocument(testFileUri);
  await vscode.window.showTextDocument(doc);
}
