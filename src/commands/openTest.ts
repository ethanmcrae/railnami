import * as vscode from 'vscode';
import { getRailsMapping } from '../rails/mapping';
import { getExpectedTestPath } from '../rails/testPath';
import { fileExists } from '../vscode/fileUtils';

export async function openTestForCurrentFile(): Promise<void> {
  const editor = vscode.window.activeTextEditor;
  if (!editor) {
    vscode.window.showErrorMessage('No active editor with a Rails file.');
    return;
  }

  const filePath = vscode.workspace.asRelativePath(editor.document.uri.fsPath);
  const mapping = getRailsMapping(filePath);
  if (!mapping || mapping.fileType === 'test') {
    vscode.window.showWarningMessage('Select a Rails class (model, controller, â€¦) to view tests for.');
    return;
  }

  const { generatorType, className } = mapping;
  const workspaceFolder = vscode.workspace.workspaceFolders?.[0];
  if (!workspaceFolder) {
    vscode.window.showErrorMessage('No workspace folder found.');
    return;
  }
  
  const testFileUri = getExpectedTestPath(generatorType, className, workspaceFolder);
  if (!(await fileExists(testFileUri))) {
    vscode.window.showErrorMessage('No test file found.');
    return;
  }

  const doc = await vscode.workspace.openTextDocument(testFileUri);
  await vscode.window.showTextDocument(doc);
}
